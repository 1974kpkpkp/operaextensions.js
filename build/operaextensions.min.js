// operaextensions.min.js - http://github.com/richtr/operaextensions.js
'use strict';(function(p){var l=p.opera||{},e=l.extension=l.extension||{REVISION:"1"};self.console=self.console||{info:function(){},log:function(){},debug:function(){},warn:function(){},error:function(){}};e.Event=function(a,d){var b=document.createEvent("Event");b.initEvent(a,!0,!0);for(var c in d)b[c]=d[c];return b};var j=e.RSVP={},i="undefined"!==typeof window?window:{},i=i.MutationObserver||i.WebKitMutationObserver;if("undefined"!==typeof process)i=function(a,d){process.nextTick(function(){a.call(d)})};
else if(i){var n=[],i=new i(function(){var a=n.slice();n=[];a.forEach(function(a){a[0].call(a[1])})}),q=document.createElement("div");i.observe(q,{attributes:!0});i=function(a,d){n.push([a,d]);q.setAttribute("drainQueue","drainQueue")}}else i=function(a,d){setTimeout(function(){a.call(d)},1)};j.async=i;var s=j.Event=function(a,d){this.type=a;for(var b in d)d.hasOwnProperty(b)&&(this[b]=d[b])},r=function(a,d){for(var b=0,c=a.length;b<c;b++)if(a[b][0]===d)return b;return-1},o=function(a){var d=a._promiseCallbacks;
d||(d=a._promiseCallbacks={});return d},i=j.EventTarget={mixin:function(a){a.on=this.on;a.off=this.off;a.trigger=this.trigger;return a},on:function(a,d,b){var c=o(this),e,b=b||this;(e=c[a])||(e=c[a]=[]);-1===r(e,d)&&e.push([d,b])},off:function(a,d){var b=o(this);if(d){var b=b[a],c=r(b,d);-1!==c&&b.splice(c,1)}else b[a]=[]},trigger:function(a,d){var b,c,e,g;if(b=o(this)[a])for(var h=0,k=b.length;h<k;h++)c=b[h],e=c[0],c=c[1],"object"!==typeof d&&(d={detail:d}),g=new s(a,d),e.call(c,g)}},m=j.Promise=
function(){this.on("promise:resolved",function(a){this.trigger("success",{detail:a.detail})},this);this.on("promise:failed",function(a){this.trigger("error",{detail:a.detail})},this)};j.invokeCallback=function(a,d,b,c){var e,g;if(b)try{e=b(c.detail)}catch(h){g=h}else e=c.detail;if(e instanceof m)e.then(function(a){d.resolve(a)},function(a){d.reject(a)});else if(b&&e)d.resolve(e);else if(g)d.reject(g);else d[a](e)};m.prototype={then:function(a,d){var b=new m;this.on("promise:resolved",function(c){j.invokeCallback("resolve",
b,a,c)});this.on("promise:failed",function(a){j.invokeCallback("reject",b,d,a)});return b},resolve:function(a){j.async(function(){this.trigger("promise:resolved",{detail:a})},this);this.resolve=function(){};this.reject=function(){}},reject:function(a){j.async(function(){this.trigger("promise:failed",{detail:a})},this);this.resolve=function(){};this.reject=function(){}}};i.mixin(m.prototype);e.Promise=function(){e.RSVP.Promise.call(this);var a=this;this._queue=[];this.resolved=!1;this.on("promise:resolved",
function(){a.resolved=!0;a.dequeue()})};e.Promise.prototype=Object.create(e.RSVP.Promise.prototype);e.Promise.prototype.addEventListener=e.Promise.prototype.on;e.Promise.prototype.removeEventListener=e.Promise.prototype.off;e.Promise.prototype.fireEvent=function(a){var d=a.type;"function"===typeof this["on"+d.toLowerCase()]&&this["on"+d.toLowerCase()].call(this,a);this.trigger(d,a)};e.Promise.prototype.enqueue=function(){if(!(1>arguments.length)){var a=arguments[0],d=[];if(1<arguments.length)for(var b=
1,c=arguments.length;b<c;b++)d.push(arguments[b]);this._queue.push({action:a,args:d})}};e.Promise.prototype.dequeue=function(){var a=this._queue[0];a&&(this._queue.splice(0,1),this[a.action]&&this[a.action].apply(this,a.args))};e.BrowserWindowsManager=function(){e.Promise.call(this);var a=this;this[0]=new e.BrowserWindow;this.length=1;this._lastFocusedWindow=this[0];chrome.windows.getAll({populate:!0},function(d){var b=[];if(0<d.length){for(var c in d[0])a[0].properties[c]=d[0][c];for(var f=[],g=
0,h=d[0].tabs.length;g<h;g++)f[g]=new e.BrowserTab(d[0].tabs[g],a[0]);a[0].tabs.replaceTabs(f);b=b.concat(f)}c=1;for(var k=d.length;c<k;c++){a[c]=new e.BrowserWindow(d[c]);a.length=c+1;f=[];g=0;for(h=d[c].tabs.length;g<h;g++)f[g]=new e.BrowserTab(d[c].tabs[g],a[c]);a[c].tabs.replaceTabs(f);b=b.concat(f)}e.tabs.replaceTabs(b);chrome.windows.getLastFocused({populate:!1},function(c){for(var d=0,b=a.length;d<b;d++)if(a[d].properties.id===c.id){a._lastFocusedWindow=a[d];break}});a.resolve();e.tabs.resolve();
c=0;for(k=a.length;c<k;c++){a[c].resolve();a[c].tabs.resolve();g=0;for(h=a[c].tabs.length;g<h;g++)a[c].tabs[g].resolve()}});chrome.windows.onCreated.addListener(function(d){window.setTimeout(function(){for(var b=!1,c=0,f=a.length;c<f;c++)if(a[c].properties.id==d.id){b=!0;break}if(!b){b=new e.BrowserWindow(d);f=[];for(c in d.tabs){var g=new e.BrowserTab(d.tabs[c],b);f.push(g)}b.tabs.replaceTabs(f);a[a.length]=b;a.length+=1;b.resolve();b.tabs.resolve();c=0;for(f=b.tabs.length;c<f;c++)b.tabs[c].resolve();
a.fireEvent(new e.Event("create",{browserWindow:b}))}},200)});chrome.windows.onRemoved.addListener(function(d){for(var b=-1,c=0,f=a.length;c<f;c++)if(a[c].properties.id==d){b=c;break}if(-1<b){a[b].fireEvent(new e.Event("close",{browserWindow:a[b]}));a.fireEvent(new e.Event("close",{browserWindow:a[b]}));c=b;for(f=a.length;c<f;c++)a[c+1]&&(a[c]=a[c+1]);delete a[a.length-1];a.length-=1}});chrome.windows.onFocusChanged.addListener(function(d){for(var b=0,c=a.length;b<c;b++)if(a[b].properties.id==d){a._lastFocusedWindow=
a[b];break}})};e.BrowserWindowsManager.prototype=Object.create(e.Promise.prototype);e.BrowserWindowsManager.prototype.create=function(a,d,b){var d=d||{},c=b||new e.BrowserWindow(d);if(!this.resolved)return this.enqueue("create",a,d,c),c;d.incognito=d.private||!1;var f=this;chrome.windows.create(d,function(d){for(var b in d)c.properties[b]=d[b];var k=[];if(d.tabs){b=0;for(var i=d.tabs.length;b<i;b++){var j=new e.BrowserTab(d.tabs[b],c);k.push(j)}}c.tabs.replaceTabs(k);f[f.length]=c;f.length+=1;c.resolve();
c.tabs.resolve();if(a)for(b in a)a[b]instanceof e.BrowserTab?function(a){chrome.tabs.move(a.properties.id,{index:-1,windowId:d.id},function(d){for(var c in d)a.properties[c]=d[c];a.resolve()})}(a[b]):a[b]instanceof e.BrowserTabGroup||function(a){var b=new e.BrowserTab(a,c);chrome.tabs.create(b.properties,{index:-1,windowId:d.id},function(a){for(var d in a)b.properties[d]=a[d];b.resolve()});c.tabs.addTabs([b])}(a[b]);f.fireEvent(new e.Event("create",{browserWindow:c}));f.dequeue()});return c};e.BrowserWindowsManager.prototype.getAll=
function(){for(var a=[],d=0,b=this.length;d<b;d++)a[d]=this[d];return a};e.BrowserWindowsManager.prototype.getLastFocused=function(){return this._lastFocusedWindow};e.BrowserWindowsManager.prototype.close=function(a){chrome.windows.remove(a.properties.id,function(){a.properties.closed=!0;a.dequeue()})};e.BrowserWindow=function(a){e.Promise.call(this);this.properties=a||{};this._parent=null;this._tabGroups=[];this._operaId=Math.floor(1E16*Math.random());this.tabs=new e.BrowserTabsManager(this)};e.BrowserWindow.prototype=
Object.create(e.Promise.prototype);e.BrowserWindow.prototype.__defineGetter__("id",function(){return this._operaId});e.BrowserWindow.prototype.__defineGetter__("closed",function(){return this.properties.closed||!1});e.BrowserWindow.prototype.__defineGetter__("focused",function(){return this.properties.focused||!1});e.BrowserWindow.prototype.__defineGetter__("private",function(){return this.properties.incognito||!1});e.BrowserWindow.prototype.__defineGetter__("parent",function(){return this._parent});
e.BrowserWindow.prototype.insert=function(a,d){if(!this.resolved||this._parent&&!this._parent.resolved||!a.resolved||d&&!d.resolved)this.enqueue("insert",a,d);else{if(!0===this.closed)throw{name:"Invalid State Error",message:"Current window is in the closed state and therefore is invalid"};var b={windowId:this.properties.id};if(d&&d instanceof e.BrowserTab){if(!0===d.closed)throw{name:"Invalid State Error",message:"'child' attribute is in the closed state and therefore is invalid"};if(d._windowParent&&
!0===d._windowParent.closed)throw{name:"Invalid State Error",message:"Parent window of 'child' attribute is in the closed state and therefore is invalid"};b.windowId=d._windowParent?d._windowParent.properties.id:b.windowId;b.index=d.position}if(a instanceof e.BrowserTab){var c=this;chrome.tabs.move(a.properties.id,b,function(){c.dequeue()})}}};e.BrowserWindow.prototype.focus=function(){!this.resolved||this._parent&&!this._parent.resolved?this.enqueue("focus"):chrome.windows.update(this.properties.id,
{focused:!0},function(){this.dequeue()})};e.BrowserWindow.prototype.update=function(a){if(!this.resolved||this._parent&&!this._parent.resolved)this.enqueue("update",a);else{for(var d in a)this.properties[d]=a[d];chrome.windows.update(this.properties.id,a,function(){this.dequeue()})}};e.BrowserWindow.prototype.close=function(){!this.resolved||this._parent&&!this._parent.resolved?this.enqueue("close"):e.windows.close(this)};e.BrowserTabsManager=function(a){e.Promise.call(this);this.length=0;this._lastFocusedTab=
null;this._parent=a;this.replaceTabs=function(a){for(var b=0,c=this.length;b<c;b++)delete this[b];b=this.length=0;for(c=a.length;b<c;b++)this!==e.tabs&&(a[b].properties.index=b),a[b].properties.closed=!1,this[b]=a[b];this.length=a.length};this.addTabs=function(a,b){for(var c=[],f=0,g=this.length;f<g;f++)c[f]=this[f];f=[b||c.length-1,0].concat(a);Array.prototype.splice.apply(c,f);f=0;for(g=c.length;f<g;f++)this!==e.tabs&&(c[f].properties.index=f),c[f].properties.closed=!1,this[f]=c[f];this.length=
c.length};this.removeTab=function(a){for(var b=this.length,c=[],f=-1,g=0,h=this.length;g<h;g++)c[g]=this[g],c[g].id==a.id&&(f=g);-1<f&&c.splice(f,1);a.properties.closed=!0;a._windowParent=null;g=0;for(h=c.length;g<h;g++)this!==e.tabs&&(c[g].properties.index=g),this[g]=c[g];this.length=c.length;if(b>this.length){g=this.length;for(h=b;g<h;g++)delete this[g]}}};e.BrowserTabsManager.prototype=Object.create(e.Promise.prototype);e.BrowserTabsManager.prototype.create=function(a,d,b){var a=a||{},c=b||new e.BrowserTab;
if(!this.resolved||this._parent&&!this._parent.resolved)return this.enqueue("create",a,d,c),c;a.pinned=a.locked||!1;a.active=a.focused||!1;delete a.focused;if(this._parent&&!0===this._parent.closed)throw{name:"Invalid State Error",message:"Parent window is in the closed state and therefore is invalid"};a.windowId=this._parent?this._parent.properties.id:null;if(d&&d instanceof e.BrowserTab){if(!0===d.closed)throw{name:"Invalid State Error",message:"'before' attribute is in the closed state and therefore is invalid"};
if(d._windowParent&&!0===d._windowParent.closed)throw{name:"Invalid State Error",message:"Parent window of 'before' attribute is in the closed state and therefore is invalid"};a.windowId=d._windowParent?d._windowParent.properties.id:a.windowId;a.index=d.position}var f=this;chrome.tabs.create(a,function(a){for(var b in a)c.properties[b]=a[b];var d=!0;if(a.windowId){var i=l.extension.windows;b=0;for(var j=i.length;b<j;b++)if(i[b].properties.id===a.windowId){d=!1;c._windowParent=i[b];break}}d&&(c._windowParent=
e.windows.getLastFocused());f.addTabs([c],c.properties.index);f!==e.tabs&&e.tabs.addTabs([c]);c.resolve(a);f.fireEvent(new e.Event("create",{tab:c,prevWindow:c._windowParent,prevTabGroup:null,prevPosition:-1}));f.dequeue()});return c};e.BrowserTabsManager.prototype.getAll=function(){for(var a=[],d=0,b=this.length;d<b;d++)a[d]=this[d];return a};e.BrowserTabsManager.prototype.getSelected=function(){return this._lastFocusedTab};e.BrowserTabsManager.prototype.getFocused=e.BrowserTabsManager.prototype.getSelected;
e.BrowserTabsManager.prototype.close=function(a){if(a)if(!this.resolved||this._parent&&!this._parent.resolved||!a.resolved)this.enqueue("close",a);else{var d=this;chrome.tabs.remove(a.properties.id,function(){a.dequeue();d.dequeue()})}};e.RootBrowserTabsManager=function(){e.BrowserTabsManager.call(this);var a=this;chrome.tabs.onCreated.addListener(function(d){window.setTimeout(function(){for(var b=!1,c=0,f=a.length;c<f;c++)if(a[c].properties.id==d.id){b=!0;break}if(!b){for(var b=new e.BrowserTab(d),
g=!0,h=l.extension.windows,c=0,f=h.length;c<f;c++)if(h[c].properties.id==d.windowId){g=!1;b._windowParent=h[c];break}g&&(b._windowParent=e.windows.getLastFocused());b._windowParent.tabs.addTabs([b],b.properties.index);b._windowParent.tabs.fireEvent(new e.Event("create",{tab:b,prevWindow:b._windowParent,prevTabGroup:null,prevPosition:NaN}));a.addTabs([b]);b.resolve();a.fireEvent(new e.Event("create",{tab:b,prevWindow:b._windowParent,prevTabGroup:null,prevPosition:NaN}))}},200)});chrome.tabs.onRemoved.addListener(function(d){for(var b=
-1,c=0,f=a.length;c<f;c++)if(a[c].properties.id==d){b=c;break}-1<b&&(b=(d=a[b])?d._windowParent:null,c=d?d.position:NaN,b&&b.tabs.removeTab(d),a.removeTab(d),d.fireEvent(new e.Event("close",{tab:d,prevWindow:b,prevTabGroup:null,prevPosition:c})),b&&b.tabs.fireEvent(new e.Event("close",{tab:d,prevWindow:b,prevTabGroup:null,prevPosition:c})),a.fireEvent(new e.Event("close",{tab:d,prevWindow:b,prevTabGroup:null,prevPosition:c})))});chrome.tabs.onUpdated.addListener(function(d,b){for(var c=-1,e=0,g=a.length;e<
g;e++)if(a[e].properties.id==d){c=e;break}if(!(0>c)){c=a[c];for(e in b)c.properties[e]=b[e];if(c._windowParent){for(var h=-1,e=0,g=c._windowParent.tabs.length;e<g;e++)if(c._windowParent.tabs[e].properties.id==d){h=e;break}if(-1<h)for(e in b)c._windowParent.tabs[h].properties[e]=b[e]}}});chrome.tabs.onMoved.addListener(function(d,b){for(var c=-1,f=0,g=a.length;f<g;f++)if(a[f].properties.id==d){c=f;break}if(!(0>c)){var h=(c=a[c])?c._windowParent:null;if(c){if(h){for(var i=-1,f=0,g=h.tabs.length;f<g;f++)if(h.tabs[f].properties.id==
d){i=f;break}if(-1<i){f=i;for(g=h.tabs.length;f<g;f++)h.tabs[f+1]&&(h.tabs[f]=h.tabs[f+1]);delete h.tabs[c._windowParent.length-1];h.tabs.length-=1}}f=0;for(g=e.windows.length;f<g;f++)if(e.windows[f].properties.id==b.windowId){e.windows[f].tabs.addTabs([c],b.toIndex);c._windowParent=e.windows[f];break}c.fireEvent(new e.Event("move",{tab:c,prevWindow:h,prevTabGroup:null,prevPosition:b.fromIndex}));a.fireEvent(new e.Event("move",{tab:c,prevWindow:h,prevTabGroup:null,prevPosition:b.fromIndex}))}}});
chrome.tabs.onHighlighted.addListener(function(a){for(var b=0,c=e.windows.length;b<c;b++)for(var f=0,g=e.windows[b].tabs.length;f<g;f++)for(var h=0,i=a.tabIds.length;h<i;h++)e.windows[b].tabs[f].properties.active=e.windows[b]==a.windowId&&e.windows[b].tabs[f].properties.id==a.tabIds[h]?!0:!1})};e.RootBrowserTabsManager.prototype=Object.create(e.BrowserTabsManager.prototype);e.BrowserTab=function(a,d){e.Promise.call(this);this.properties=a||{};this._windowParent=d;this._operaId=Math.floor(1E16*Math.random())};
e.BrowserTab.prototype=Object.create(e.Promise.prototype);e.BrowserTab.prototype.__defineGetter__("id",function(){return this._operaId});e.BrowserTab.prototype.__defineGetter__("closed",function(){return this.properties.closed||!1});e.BrowserTab.prototype.__defineGetter__("locked",function(){return this.properties.pinned||!1});e.BrowserTab.prototype.__defineGetter__("focused",function(){return this.properties.active||!1});e.BrowserTab.prototype.__defineGetter__("selected",function(){return this.properties.active||
!1});e.BrowserTab.prototype.__defineGetter__("private",function(){return this.properties.incognito||!1});e.BrowserTab.prototype.__defineGetter__("faviconUrl",function(){return this.properties.closed?"":this.properties.favIconUrl||""});e.BrowserTab.prototype.__defineGetter__("title",function(){return this.properties.closed?"":this.properties.title||""});e.BrowserTab.prototype.__defineGetter__("url",function(){return this.properties.closed?"":this.properties.url||""});e.BrowserTab.prototype.__defineGetter__("readyState",
function(){return this.properties.status||"loading"});e.BrowserTab.prototype.__defineGetter__("browserWindow",function(){return this._windowParent});e.BrowserTab.prototype.__defineGetter__("tabGroup",function(){return null});e.BrowserTab.prototype.__defineGetter__("position",function(){return this.properties.index||NaN});e.BrowserTab.prototype.close=function(){e.tabs.close(this)};e.BrowserTab.prototype.focus=function(){if(!this.resolved||this._windowParent&&!this._windowParent.resolved||this._windowParent&&
this._windowParent._parent&&!this._windowParent._parent.resolved)this.enqueue("focus");else{var a=this;chrome.tabs.update(this.properties.id,{active:!0},function(){a.dequeue()})}};e.BrowserTab.prototype.update=function(a){if(!this.resolved||this._windowParent&&!this._windowParent.resolved||this._windowParent&&this._windowParent._parent&&!this._windowParent._parent.resolved)this.enqueue("update",a);else{for(var d in a)this.properties[d]=a[d];a.active=a.focused||!1;a.pinned=a.locked||!1;delete a.focused;
var b=this;chrome.tabs.update(this.properties.id,a,function(){b.dequeue()})}};e.BrowserTab.prototype.refresh=function(){};e.windows=new e.BrowserWindowsManager;e.tabs=new e.RootBrowserTabsManager;p.opera=l})(window);
